<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SM Architect v4.2 (Final Fixes)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Segoe+UI:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { background-color: #0f0f0f; color: #e5e5e5; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        #viewport { flex: 1; overflow: hidden; position: relative; background-color: #121212; cursor: grab; display: flex; align-items: center; justify-content: center; }
        #viewport:active { cursor: grabbing; }
        #canvas-container { transition: transform 0.1s ease-out; display: flex; align-items: center; justify-content: center; width: 0; height: 0; }
        .bg-grid { position: absolute; inset: -500%; z-index: 0; background-image: radial-gradient(#333 1px, transparent 1px); background-size: 20px 20px; opacity: 0.4; pointer-events: none; }
        @keyframes popIn { 0% { transform: scale(0); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        
        .sm-block {
            width: 100px; height: 100px; 
            background: radial-gradient(circle at top left, #2a2a2a, #161616);
            border: 2px solid #444; border-radius: 8px;
            display: flex; flex-direction: column; justify-content: space-between;
            position: relative; z-index: 10;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            transition: all 0.1s ease; overflow: hidden;
        }
        .icon-container { flex-grow: 1; display: flex; align-items: center; justify-content: center; padding: 4px; width: 100%; overflow: hidden; }
        .img-layer { max-width: 100%; max-height: 100%; object-fit: contain; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.8)); }
        .emoji-layer { font-size: 32px; }
        .sm-block-title { 
            width: 100%; background: rgba(0,0,0,0.7); border-top: 1px solid rgba(255,255,255,0.05);
            font-size: 9px; font-weight: bold; text-transform: uppercase; color: #bbb; text-align: center; 
            padding: 3px 1px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex-shrink: 0;
        }
        .block-idx { 
            position: absolute; top: -6px; left: -6px; background: #333; color: #fff; 
            width: 20px; height: 20px; border-radius: 50%; border: 1px solid #555; 
            font-family: monospace; font-size: 10px; font-weight: bold; 
            display: flex; align-items: center; justify-content: center; z-index: 20;
        }

        /* –¢–∏–ø—ã */
        .type-input { border-color: #22c55e; } .type-logic { border-color: #a855f7; }
        .type-math { border-color: #f97316; } .type-output { border-color: #ef4444; } .type-util { border-color: #3b82f6; }
        .type-hidden { opacity: 0.5; border-style: dashed; }

        /* –ü–æ–¥—Å–≤–µ—Ç–∫–∞ (FIXED) */
        .sm-block.active-highlight { 
            border-color: #fb923c !important; box-shadow: 0 0 0 4px rgba(251, 146, 60, 0.3), 0 10px 30px rgba(0,0,0,0.8) !important; 
            transform: scale(1.2) !important; z-index: 100 !important; background: #333 !important;
        }
        .sm-block:hover { border-color: #fff; transform: scale(1.05); z-index: 40; cursor: help; }
        
        .interactive-link { color: #fb923c; cursor: pointer !important; border-bottom: 1px dotted #fb923c; font-weight: bold; transition: all 0.2s; }
        .interactive-link:hover { background: #fb923c; color: #000; border-radius: 2px; }

        .nav-item { width: 100%; aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #666; cursor: pointer; transition: all 0.2s; border-left: 3px solid transparent; }
        .nav-item:hover { background: #222; color: #fff; }
        .nav-item.active { color: #fb923c; border-left-color: #fb923c; background: #1a1a1a; }
        .nav-label { font-size: 0.6rem; font-weight: bold; text-transform: uppercase; margin-top: 2px;}
        
        ::-webkit-scrollbar { width: 4px; } ::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }
    </style>
</head>
<body class="flex h-screen text-sm bg-[#0f0f0f] overflow-hidden">

    <nav class="w-16 bg-[#0a0a0a] border-r border-[#222] flex flex-col items-center py-2 z-50 shadow-xl shrink-0">
        <div class="mb-4 text-orange-500 text-xl font-bold cursor-default select-none">üõ†</div>
        <div class="flex-1 w-full space-y-2 overflow-y-auto no-scrollbar flex flex-col items-center">
            <button onclick="filterCategory('input')" class="nav-item" id="nav-input"><img src="assets/icon_input.png" class="w-8 h-8 object-contain opacity-80 hover:opacity-100 transition-opacity" onerror="this.style.display='none'; this.nextElementSibling.style.display='block'"><span class="text-2xl hidden">üéÆ</span><span class="nav-label">–í–≤–æ–¥</span></button>
            <button onclick="filterCategory('logic')" class="nav-item" id="nav-logic"><img src="assets/icon_logic.png" class="w-8 h-8 object-contain opacity-80 hover:opacity-100 transition-opacity" onerror="this.style.display='none'; this.nextElementSibling.style.display='block'"><span class="text-2xl hidden">üß†</span><span class="nav-label">–õ–æ–≥–∏–∫–∞</span></button>
            <button onclick="filterCategory('output')" class="nav-item" id="nav-output"><img src="assets/icon_output.png" class="w-8 h-8 object-contain opacity-80 hover:opacity-100 transition-opacity" onerror="this.style.display='none'; this.nextElementSibling.style.display='block'"><span class="text-2xl hidden">‚öôÔ∏è</span><span class="nav-label">–ú–µ—Ö.</span></button>
            <button onclick="filterCategory('util')" class="nav-item" id="nav-util"><img src="assets/icon_util.png" class="w-8 h-8 object-contain opacity-80 hover:opacity-100 transition-opacity" onerror="this.style.display='none'; this.nextElementSibling.style.display='block'"><span class="text-2xl hidden">üß∞</span><span class="nav-label">–£—Ç–∏–ª.</span></button>
        </div>
        <div class="w-full mt-auto border-t border-[#222] pt-2 space-y-1">
            <button onclick="resetView()" class="nav-item" title="–°–±—Ä–æ—Å"><span class="text-xl">üéØ</span></button>
            <button onclick="openWiki()" class="nav-item" title="–í–∏–∫–∏–ø–µ–¥–∏—è"><span class="text-xl">üìñ</span></button>
            <button onclick="openAdmin()" class="nav-item" title="–ê–¥–º–∏–Ω–∫–∞"><span class="text-xl">‚öôÔ∏è</span></button>
        </div>
    </nav>

    <aside id="blockDrawer" class="w-64 bg-[#141414] border-r border-[#222] flex flex-col z-40 drawer-enter hidden relative shadow-2xl">
        <div class="p-4 border-b border-[#222] flex justify-between items-center bg-[#1a1a1a]"><h2 id="drawerTitle" class="font-bold text-gray-200 text-sm uppercase tracking-wider">–ë–ª–æ–∫–∏</h2><button onclick="closeDrawer()" class="text-gray-500 hover:text-white">‚úï</button></div>
        <div class="p-2 border-b border-[#222]"><input type="text" id="searchBox" placeholder="–ü–æ–∏—Å–∫..." class="w-full bg-[#0a0a0a] border border-[#333] rounded px-3 py-1 text-xs text-white focus:border-orange-500 outline-none"></div>
        <div id="menuList" class="flex-1 overflow-y-auto p-2 space-y-1"></div>
    </aside>

    <main class="flex-1 flex flex-col relative bg-[#121212]">
        <div id="topPanel" class="absolute top-0 left-0 right-0 bg-[#1a1a1a]/90 backdrop-blur border-b border-[#333] p-4 z-10 hidden shadow-lg"><div class="flex justify-between items-start max-w-3xl mx-auto"><div><h2 class="text-lg font-bold text-orange-400 mb-1" id="infoTitle"></h2><div class="text-gray-400 text-xs leading-relaxed" id="infoDesc"></div></div><button onclick="document.getElementById('topPanel').classList.add('hidden')" class="text-gray-500 hover:text-white ml-4">‚úï</button></div></div>
        <div id="viewport" onclick="closeDrawerMobile()"><div id="canvas-container"><div class="bg-grid"></div><div id="canvas" class="flex flex-wrap gap-10 justify-center w-[800px] pointer-events-none p-20"><div class="text-gray-600 text-center mt-20 pointer-events-none select-none"><div class="text-4xl mb-2">üõ†</div><div>–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é —Å–ª–µ–≤–∞</div></div></div></div></div>
        <button onclick="toggleInspector()" class="fixed bottom-6 right-6 w-12 h-12 bg-orange-600 text-white rounded-full shadow-lg flex items-center justify-center text-xl font-bold z-50 hover:bg-orange-500 lg:hidden">i</button>
        <div id="connectionsPanel" class="fixed bottom-0 right-0 w-full lg:w-80 bg-[#1a1a1a] border-t lg:border-l border-[#333] z-30 transform translate-y-full lg:translate-y-0 transition-transform duration-300 flex flex-col h-1/2 lg:h-auto lg:static hidden lg:flex shadow-2xl"><div class="p-3 border-b border-[#333] bg-[#222] flex justify-between items-center"><h3 class="font-bold text-orange-500 text-xs uppercase tracking-widest">üì° Connections</h3><button onclick="toggleInspector()" class="lg:hidden text-gray-400">‚ñº</button></div><div id="connectionsList" class="p-4 overflow-y-auto flex-1 space-y-2 text-xs font-mono text-gray-400"><div class="text-center opacity-50 mt-4">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π —Å—Ö–µ–º—ã</div></div></div>
    </main>

    <div id="wikiModal" class="fixed inset-0 bg-black/90 hidden z-[60] flex items-center justify-center p-4 backdrop-blur-sm" onclick="if(event.target===this)closeWiki()"><div class="bg-[#1a1a1a] w-full max-w-4xl h-[80vh] rounded-xl border border-[#333] flex flex-col shadow-2xl"><div class="p-4 border-b border-[#333] flex justify-between items-center"><h2 class="text-lg font-bold text-orange-500">üìö Wiki</h2><button onclick="closeWiki()" class="text-2xl text-gray-500 hover:text-white">&times;</button></div><div class="p-6 overflow-y-auto space-y-6 text-gray-300" id="wikiContent"></div></div></div>
    <div id="adminModal" class="fixed inset-0 bg-black/95 hidden z-[70] flex items-center justify-center p-4 backdrop-blur-md" onclick="if(event.target===this)closeAdmin()"><div class="bg-[#1a1a1a] w-full max-w-2xl rounded-xl border border-[#333] flex flex-col shadow-2xl max-h-[80vh]"><div class="p-4 border-b border-[#333] flex justify-between items-center"><h2 class="text-lg font-bold text-blue-400">‚öôÔ∏è Admin</h2><button onclick="closeAdmin()" class="text-gray-500 hover:text-white">‚úï</button></div><div class="p-4 overflow-y-auto flex-1 space-y-3"><p class="text-[10px] text-gray-500 uppercase">–ò–º–ø–æ—Ä—Ç JSON</p><textarea id="universalImport" class="w-full h-40 bg-[#0a0a0a] border border-[#333] rounded p-2 text-xs font-mono text-green-400 focus:border-blue-500 outline-none"></textarea><div class="flex gap-2 pt-2"><button onclick="copyKeys()" class="px-3 py-2 bg-[#222] text-gray-300 rounded border border-[#333] hover:text-white text-xs font-bold flex-1">üìã Copy Keys</button><button onclick="universalMerge()" class="px-3 py-2 bg-blue-900/30 text-blue-300 rounded border border-blue-800 hover:bg-blue-800 hover:text-white text-xs font-bold flex-1">Import</button></div><div id="adminLog" class="text-[10px] text-gray-500 h-10 overflow-y-auto"></div></div></div></div>

<script src="blocks.js"></script>
<script src="wiki.js"></script>
<script src="presets.js"></script>

<script>
    const library = { blocks: window.SM_BLOCKS || {}, wiki: window.SM_WIKI || {}, presets: window.SM_PRESETS || {} };
    let scale = 1, pointX = 0, pointY = 0, isDragging = false, startX, startY, currentCategory = null;
    const viewport = document.getElementById('viewport');
    const container = document.getElementById('canvas-container');
    const categoryMap = { 'input': ['input', 'sensor'], 'logic': ['logic', 'math'], 'output': ['output'], 'util': ['util'] };

    function init() { setupZoomPan(); console.log("‚úÖ System v4.1 initialized"); }

    window.filterCategory = function(catName) {
        const drawer = document.getElementById('blockDrawer');
        const title = document.getElementById('drawerTitle');
        if (currentCategory === catName) {
            drawer.classList.add('hidden');
            currentCategory = null;
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        } else {
            drawer.classList.remove('hidden');
            currentCategory = catName;
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`nav-${catName}`).classList.add('active');
            const titles = { 'input': '–í–≤–æ–¥ –∏ –°–µ–Ω—Å–æ—Ä—ã', 'logic': '–õ–æ–≥–∏–∫–∞ –∏ –ö–æ–Ω—Ç—Ä–æ–ª—å', 'output': '–ú–µ—Ö–∞–Ω–∏–∫–∞', 'util': '–£—Ç–∏–ª–∏—Ç—ã' };
            title.innerText = titles[catName] || '–ë–ª–æ–∫–∏';
            renderFilteredList(categoryMap[catName]);
        }
    }

    function renderFilteredList(allowedTypes) {
        const list = document.getElementById('menuList');
        list.innerHTML = '';
        const keys = Object.keys(library.blocks).filter(k => { const b = library.blocks[k]; return b.type !== 'hidden' && allowedTypes.includes(b.type); });
        if (keys.length === 0) { list.innerHTML = '<div class="text-gray-500 text-xs text-center mt-4">–ü—É—Å—Ç–æ</div>'; return; }
        keys.forEach(key => {
            const b = library.blocks[key];
            const hasPreset = library.presets[key] && library.presets[key].length > 0;
            const div = document.createElement('div');
            div.className = 'flex items-center gap-3 p-2 rounded hover:bg-[#222] cursor-pointer transition group';
            if (hasPreset) div.classList.add('bg-[#1a1a1a]', 'border-l-2', 'border-orange-500/50');
            div.onclick = () => { if(hasPreset) window.showPresets(key); else alert("–°—Ö–µ–º –ø–æ–∫–∞ –Ω–µ—Ç."); if(window.innerWidth < 1024) window.closeDrawer(); };
            let icon = b.img ? `<img src="${b.img}" class="w-6 h-6 object-contain" onerror="this.style.display='none';this.nextElementSibling.style.display='block'"><span class="text-lg hidden">${b.icon}</span>` : `<span class="text-lg">${b.icon}</span>`;
            div.innerHTML = `${icon}<div class="flex-1 min-w-0"><div class="text-xs font-bold text-gray-300 truncate group-hover:text-white">${b.name}</div>${hasPreset ? '<div class="text-[9px] text-orange-500">–ï—Å—Ç—å —Å—Ö–µ–º—ã</div>' : ''}</div>`;
            list.appendChild(div);
        });
    }

    window.closeDrawer = function() { document.getElementById('blockDrawer').classList.add('hidden'); document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active')); currentCategory = null; }
    window.closeDrawerMobile = function() { if(window.innerWidth < 1024) window.closeDrawer(); }

    window.showPresets = function(targetKey) {
        const canvas = document.getElementById('canvas');
        const presets = library.presets[targetKey];
        window.resetView();
        document.getElementById('topPanel').classList.add('hidden');
        document.getElementById('connectionsList').innerHTML = '';
        if(window.innerWidth < 1024) document.getElementById('connectionsPanel').classList.add('translate-y-full');
        if (!presets) return;
        if (presets.length === 1) { loadPreset(targetKey, 0); return; }
        canvas.innerHTML = '';
        presets.forEach((p, idx) => { canvas.innerHTML += `<button onclick="loadPreset('${targetKey}', ${idx})" class="p-4 bg-[#222] border border-[#444] rounded hover:border-orange-500 text-gray-200 pointer-events-auto transition hover:scale-105 shadow-lg">${p.name}</button>`; });
    }

    window.loadPreset = function(targetKey, idx) {
        const preset = library.presets[targetKey][idx];
        document.getElementById('infoTitle').innerText = preset.name;
        document.getElementById('infoDesc').innerHTML = preset.desc || "";
        document.getElementById('topPanel').classList.remove('hidden');
        const canvas = document.getElementById('canvas'); canvas.innerHTML = '';
        let chainObjects = [];
        if (preset.chain) {
            preset.chain.forEach((key, i) => {
                let b = library.blocks[key] || { name: "UNKNOWN", icon: "?", type: "hidden" };
                chainObjects.push({ ...b, key: key, idx: i + 1 });
            });
        }
        chainObjects.forEach(b => {
            const el = document.createElement('div');
            el.className = 'node-wrapper animate-[popIn_0.2s_ease-out]';
            const hasWiki = library.wiki[b.key];
            const clickAttr = hasWiki ? `onclick="openWikiKey('${b.key}')"` : '';
            const cursorClass = hasWiki ? 'cursor-help' : '';
            let content = b.img ? `<img src="${b.img}" class="img-layer" onerror="this.style.display='none';this.nextElementSibling.style.display='block'"><div class="emoji-layer hidden">${b.icon}</div>` : `<div class="emoji-layer">${b.icon}</div>`;
            el.innerHTML = `<div class="sm-block type-${b.type} ${cursorClass}" ${clickAttr} id="block-${b.idx}"><div class="block-idx">${b.idx}</div><div class="icon-container">${content}</div><div class="sm-block-title">${b.name}</div></div>`;
            canvas.appendChild(el);
        });
        const connList = document.getElementById('connectionsList');
        if(preset.connections) {
            connList.innerHTML = preset.connections.map(text => {
                let interactiveText = text.replace(/\[(\d+)\]/g, (match, id) => `<span class="text-orange-400 font-bold cursor-pointer hover:underline" onmouseenter="window.hi(${id})" onmouseleave="window.lo(${id})">[${id}]</span>`);
                return `<div class="p-2 bg-[#222] rounded border-l-2 border-orange-500 hover:bg-[#2a2a2a] transition text-xs">${interactiveText}</div>`;
            }).join('');
        }
        if(window.innerWidth < 1024) window.toggleInspector(true);
    }

    window.hi = function(id) { const el = document.getElementById(`block-${id}`); if(el) { el.classList.add('active-highlight'); el.style.transform = "scale(1.2)"; el.style.zIndex = "100"; } }
    window.lo = function(id) { const el = document.getElementById(`block-${id}`); if(el) { el.classList.remove('active-highlight'); el.style.transform = "scale(1)"; el.style.zIndex = "10"; } }
    window.resetView = function() { scale = 1; pointX = 0; pointY = 0; updateTransform(); }
    function updateTransform() { container.style.transform = `translate(${pointX}px, ${pointY}px) scale(${scale})`; }
    function setupZoomPan() {
        viewport.addEventListener('mousedown', e => { isDragging = true; startX = e.clientX - pointX; startY = e.clientY - pointY; });
        window.addEventListener('mousemove', e => { if(!isDragging) return; e.preventDefault(); pointX = e.clientX - startX; pointY = e.clientY - startY; updateTransform(); });
        window.addEventListener('mouseup', () => isDragging = false);
        viewport.addEventListener('wheel', e => { e.preventDefault(); scale += e.deltaY > 0 ? -0.1 : 0.1; scale = Math.min(Math.max(0.2, scale), 3); updateTransform(); });
        viewport.addEventListener('touchstart', e => { if(e.touches.length===1) { isDragging=true; startX=e.touches[0].clientX-pointX; startY=e.touches[0].clientY-pointY; } });
        viewport.addEventListener('touchmove', e => { if(isDragging && e.touches.length===1) { e.preventDefault(); pointX=e.touches[0].clientX-startX; pointY=e.touches[0].clientY-startY; updateTransform(); } });
        viewport.addEventListener('touchend', () => isDragging=false);
    }

    window.openWiki = () => { renderWiki(); document.getElementById('wikiModal').classList.remove('hidden'); }
    window.openWikiKey = (key) => { openWiki(); setTimeout(() => document.getElementById(`wiki-${key}`)?.scrollIntoView({block:'center'}), 100); }
    window.closeWiki = () => document.getElementById('wikiModal').classList.add('hidden');
    window.openAdmin = () => document.getElementById('adminModal').classList.remove('hidden');
    window.closeAdmin = () => document.getElementById('adminModal').classList.add('hidden');
    window.toggleInspector = (forceOpen) => {
        const panel = document.getElementById('connectionsPanel');
        if (forceOpen === true) panel.classList.remove('translate-y-full');
        else if (forceOpen === false) panel.classList.add('translate-y-full');
        else panel.classList.toggle('translate-y-full');
    }
    function renderWiki() {
        const c = document.getElementById('wikiContent'); 
        if(c.innerHTML !== "") return;
        const categories = { "Input": [], "Logic": [], "Math/Util": [], "Output": [], "Misc": [], "Fant Mod": [] };
        for (const [k, i] of Object.entries(library.wiki)) {
            let cat = i.category || "Misc";
            if (cat.includes("Fant")) cat = "Fant Mod"; 
            if(!categories[cat]) categories[cat] = [];
            let iconHTML = i.img ? `<div class="w-12 h-12 flex items-center justify-center bg-[#111] rounded border border-[#333]"><img src="${i.img}" class="w-full h-full object-contain"></div>` : `<span class="text-3xl">${i.icon || 'üîπ'}</span>`;
            categories[cat].push(`<div id="wiki-${k}" class="bg-[#222] p-5 rounded border border-[#333] mb-4 transition hover:border-orange-500/50"><div class="flex gap-4 items-start">${iconHTML}<div><h3 class="text-lg font-bold text-orange-400 mb-1">${i.title}</h3><p class="text-gray-300 text-sm leading-relaxed">${i.text}</p></div></div></div>`);
        }
        for (const [catName, items] of Object.entries(categories)) {
            if(items.length > 0) { c.innerHTML += `<div class="text-orange-500 font-bold uppercase tracking-widest text-xs border-b border-[#333] pb-1 mb-4 mt-8">${catName}</div>`; c.innerHTML += items.join(''); }
        }
    }
    window.copyKeys = () => { navigator.clipboard.writeText(Object.keys(library.blocks).join(', ')); document.getElementById('adminLog').innerText = "–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!"; }
    window.universalMerge = () => { alert("–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ GitHub!"); }
    window.downloadDB = () => { alert("–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ GitHub."); }

    init();
</script>
</body>
</html>
